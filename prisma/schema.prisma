generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model contratos {
  id              BigInt        @id @default(autoincrement())
  departamento_id BigInt
  inquilino_id    BigInt
  fecha_inicio    DateTime      @db.Date
  fecha_fin       DateTime?     @db.Date
  monto_mensual   Decimal       @db.Decimal(12, 2)
  dia_vencimiento Int           @default(5)
  estado          String        @default("activo") @db.VarChar(20)
  creado_en       DateTime      @default(now()) @db.Timestamp(6)
  actualizado_en  DateTime      @default(now()) @db.Timestamp(6)
  departamentos   departamentos @relation(fields: [departamento_id], references: [id], onUpdate: NoAction)
  inquilinos      inquilinos    @relation(fields: [inquilino_id], references: [id], onUpdate: NoAction)
  pagos           pagos[]

  @@index([departamento_id], map: "idx_contratos_dep")
  @@index([estado], map: "idx_contratos_estado")
  @@index([inquilino_id], map: "idx_contratos_inq")
}

model departamentos {
  id             BigInt      @id @default(autoincrement())
  usuario_id     BigInt?
  nombre         String      @db.VarChar(120)
  direccion      String?     @db.VarChar(255)
  descripcion    String?
  precio_mensual Decimal     @default(0) @db.Decimal(12, 2)
  estado         String      @default("disponible") @db.VarChar(20)
  creado_en      DateTime    @default(now()) @db.Timestamp(6)
  actualizado_en DateTime    @default(now()) @db.Timestamp(6)
  contratos      contratos[]
  usuarios       usuarios?   @relation(fields: [usuario_id], references: [id], onUpdate: NoAction)
}

model estados_pago {
  id          Int     @id @default(autoincrement())
  nombre      String  @unique @db.VarChar(50)
  descripcion String?
  color_hex   String? @db.VarChar(7)
  orden       Int     @default(0)
  pagos       pagos[]
}

model inquilinos {
  id             BigInt      @id @default(autoincrement())
  nombre         String      @db.VarChar(120)
  apellido       String?     @db.VarChar(120)
  dni            String      @unique @db.VarChar(20)
  telefono       String?     @db.VarChar(20)
  correo         String?     @unique @db.VarChar(120)
  direccion      String?     @db.VarChar(255)
  creado_en      DateTime    @default(now()) @db.Timestamp(6)
  actualizado_en DateTime    @default(now()) @db.Timestamp(6)
  contratos      contratos[]
}

model pagos {
  id             BigInt       @id @default(autoincrement())
  contrato_id    BigInt
  periodo        DateTime     @db.Date
  monto_esperado Decimal      @db.Decimal(12, 2)
  monto_pagado   Decimal      @default(0) @db.Decimal(12, 2)
  metodo         String?      @db.VarChar(50)
  estado_id      Int
  fecha_pago     DateTime?    @db.Timestamp(6)
  notas          String?
  comprobante_pago String?     @db.VarChar(255)
  recibo_pago     String?     @db.VarChar(255)
  creado_en      DateTime     @default(now()) @db.Timestamp(6)
  actualizado_en DateTime     @default(now()) @db.Timestamp(6)
  tipo_pago_id   Int?
  contratos      contratos    @relation(fields: [contrato_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  estados_pago   estados_pago @relation(fields: [estado_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tipos_pago     TiposPago?   @relation(fields: [tipo_pago_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([contrato_id, periodo, tipo_pago_id], map: "uq_pago_periodo")
  @@index([contrato_id], map: "idx_pagos_contrato")
  @@index([estado_id], map: "idx_pagos_estado")
  @@index([periodo(sort: Desc)], map: "idx_pagos_periodo")
}

model TiposPago {
  id          Int     @id @default(autoincrement())
  nombre      String  @unique @db.VarChar(100)
  descripcion String?
  pagos       pagos[]

  @@map("tipos_pago")
}

model usuarios {
  id             BigInt          @id @default(autoincrement())
  nombre         String          @db.VarChar(100)
  email          String          @unique @db.VarChar(150)
  password_hash  String          @db.VarChar(255)
  rol            String          @default("admin") @db.VarChar(30)
  creado_en      DateTime        @default(now()) @db.Timestamp(6)
  actualizado_en DateTime        @default(now()) @db.Timestamp(6)
  departamentos  departamentos[]
}
